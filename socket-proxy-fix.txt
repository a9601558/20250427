# 修复Socket.IO连接的Nginx配置（放在站点配置文件中）

# 首先添加一个地图，正确处理WebSocket协议升级
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# 然后在server块内添加以下location配置
location /socket.io/ {
    # 指向Node.js服务器
    proxy_pass http://127.0.0.1:5000;
    
    # WebSocket支持关键配置
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    
    # 其他必要的代理头
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # 禁用缓存
    proxy_buffering off;
    
    # 延长超时时间
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
}

# 普通API请求的处理
location /api/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# 在宝塔面板中应用此配置后，重启Nginx服务 