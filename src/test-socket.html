<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.io 连接测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #f9f9f9;
    }
    button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin: 10px 0;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .log {
      background-color: #000;
      color: #0f0;
      font-family: monospace;
      padding: 10px;
      height: 200px;
      overflow: auto;
      margin-top: 20px;
      border-radius: 4px;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #ff9800; }
    .info { color: #2196F3; }
  </style>
</head>
<body>
  <h1>Socket.io 连接测试工具</h1>
  
  <div class="card">
    <h2>连接配置</h2>
    <div>
      <label for="serverUrl">服务器地址:</label>
      <input type="text" id="serverUrl" placeholder="http://localhost:5000" style="width: 300px">
    </div>
    <div style="margin-top: 10px;">
      <label for="token">认证令牌:</label>
      <textarea id="token" placeholder="输入JWT令牌..."></textarea>
    </div>
    <div>
      <label for="userId">用户ID:</label>
      <input type="text" id="userId" placeholder="test-user-id">
    </div>
    <div style="margin-top: 15px;">
      <button id="connectBtn">连接</button>
      <button id="disconnectBtn" disabled>断开</button>
      <button id="getTokenBtn">从localStorage获取令牌</button>
    </div>
  </div>
  
  <div class="card">
    <h2>发送事件</h2>
    <div>
      <label for="eventName">事件名称:</label>
      <input type="text" id="eventName" value="ping">
    </div>
    <div style="margin-top: 10px;">
      <label for="eventData">事件数据 (JSON):</label>
      <textarea id="eventData">{
  "message": "Hello from test client!"
}</textarea>
    </div>
    <button id="sendEventBtn" disabled>发送事件</button>
  </div>
  
  <div class="card">
    <h2>日志输出</h2>
    <div class="log" id="log"></div>
    <button id="clearLogBtn">清除日志</button>
  </div>

  <!-- 引入Socket.io客户端 -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  
  <script>
    let socket = null;
    const log = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const sendEventBtn = document.getElementById('sendEventBtn');
    const getTokenBtn = document.getElementById('getTokenBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');
    
    // 日志函数
    function logMessage(message, type = 'default') {
      const entry = document.createElement('div');
      entry.className = type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    
    // 从localStorage获取令牌
    getTokenBtn.addEventListener('click', () => {
      const token = localStorage.getItem('token');
      if (token) {
        document.getElementById('token').value = token;
        logMessage(`从localStorage获取了令牌: ${token.substring(0, 20)}...`, 'info');
      } else {
        logMessage('localStorage中没有找到token', 'warning');
      }
    });
    
    // 连接函数
    connectBtn.addEventListener('click', () => {
      if (socket) {
        logMessage('已经连接，请先断开', 'warning');
        return;
      }
      
      const serverUrl = document.getElementById('serverUrl').value.trim() || 'http://localhost:5000';
      const token = document.getElementById('token').value.trim();
      const userId = document.getElementById('userId').value.trim() || 'test-user-id';
      
      if (!token) {
        logMessage('请输入认证令牌', 'error');
        return;
      }
      
      try {
        logMessage(`尝试连接到 ${serverUrl}...`, 'info');
        
        // 创建Socket实例
        socket = io(serverUrl, {
          transports: ['websocket'],
          auth: {
            token: token,
            userId: userId
          },
          query: {
            token: token,
            userId: userId
          }
        });
        
        // 监听连接事件
        socket.on('connect', () => {
          logMessage('已连接!', 'success');
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          sendEventBtn.disabled = false;
        });
        
        // 监听断开连接事件
        socket.on('disconnect', (reason) => {
          logMessage(`断开连接: ${reason}`, 'warning');
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          sendEventBtn.disabled = true;
        });
        
        // 监听错误事件
        socket.on('connect_error', (error) => {
          logMessage(`连接错误: ${error.message}`, 'error');
        });
        
        // 监听所有事件
        socket.onAny((eventName, ...args) => {
          logMessage(`收到事件: ${eventName}`, 'info');
          logMessage(`数据: ${JSON.stringify(args)}`, 'info');
        });
        
      } catch (error) {
        logMessage(`错误: ${error.message}`, 'error');
      }
    });
    
    // 断开连接函数
    disconnectBtn.addEventListener('click', () => {
      if (socket) {
        socket.disconnect();
        socket = null;
        logMessage('手动断开连接', 'info');
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        sendEventBtn.disabled = true;
      }
    });
    
    // 发送事件函数
    sendEventBtn.addEventListener('click', () => {
      if (!socket || !socket.connected) {
        logMessage('未连接，无法发送事件', 'error');
        return;
      }
      
      const eventName = document.getElementById('eventName').value.trim();
      const eventDataStr = document.getElementById('eventData').value.trim();
      
      if (!eventName) {
        logMessage('请输入事件名称', 'error');
        return;
      }
      
      try {
        const eventData = eventDataStr ? JSON.parse(eventDataStr) : {};
        logMessage(`发送事件: ${eventName}`, 'info');
        logMessage(`数据: ${JSON.stringify(eventData)}`, 'info');
        socket.emit(eventName, eventData);
      } catch (error) {
        logMessage(`发送失败: ${error.message}`, 'error');
      }
    });
    
    // 清除日志
    clearLogBtn.addEventListener('click', () => {
      log.innerHTML = '';
    });
    
    // 初始化填充默认值
    window.addEventListener('DOMContentLoaded', () => {
      // 自动填充服务器地址
      const currentHost = window.location.hostname;
      let defaultUrl = '';
      
      if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
        defaultUrl = 'http://localhost:5000';
      } else {
        const protocol = window.location.protocol;
        defaultUrl = `${protocol}//${currentHost}`;
      }
      
      document.getElementById('serverUrl').value = defaultUrl;
      
      // 尝试获取令牌
      const token = localStorage.getItem('token');
      if (token) {
        document.getElementById('token').value = token;
        logMessage('自动从localStorage加载了令牌', 'info');
      }
      
      logMessage('测试工具已初始化完成', 'info');
    });
  </script>
</body>
</html> 