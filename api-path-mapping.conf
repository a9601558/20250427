# API路径映射配置 - 包含到Nginx配置中
# 使用方法: 在nginx.conf的server块中添加: include api-path-mapping.conf;

# CORS 支持设置
map $uri $cors_header {
  default '';
  ~^/api/ '*';
}

# 通用CORS设置宏
geo $use_cors_settings {
  default 0;
  "~.*" 1;
}

# 用于在每个API路径中重用的代理设置
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
proxy_set_header Host exam7.jp;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# CORS 头部设置
add_header 'Access-Control-Allow-Origin' $cors_header always;
add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;

# OPTIONS 请求处理
map $request_method $options_response {
  default '';
  OPTIONS 204;
}

# 用户注册
location = /api/users/register {
  if ($request_method = OPTIONS) { return 204; }
  proxy_pass http://127.0.0.1:5000/api/users/register;
}

# 用户登录
location = /api/users/login {
  if ($request_method = OPTIONS) { return 204; }
  proxy_pass http://127.0.0.1:5000/api/users/login;
}

# 用户信息
location = /api/users/me {
  if ($request_method = OPTIONS) { return 204; }
  proxy_pass http://127.0.0.1:5000/api/users/me;
}

# 题库相关
location ~ ^/api/question-sets(.*) {
  rewrite ^/api/question-sets(.*) /question-sets$1 break;
  proxy_pass http://127.0.0.1:5000;
  include api-proxy-settings.conf;
}

# 兑换码相关
location ~ ^/api/redeem-codes(.*) {
  rewrite ^/api/redeem-codes(.*) /redeem-codes$1 break;
  proxy_pass http://127.0.0.1:5000;
  include api-proxy-settings.conf;
}

# 通用代理规则 - 处理其他未指定的API请求
location /api/ {
  if ($request_method = OPTIONS) { return 204; }
  rewrite ^/api/(.*) /$1 break;
  proxy_pass http://127.0.0.1:5000;
  include api-proxy-settings.conf;
} 